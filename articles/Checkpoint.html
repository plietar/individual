<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saving and restoring simulation state • individual</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Saving and restoring simulation state">
<meta property="og:description" content="individual">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">individual</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.12</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/API.html">API</a>
    </li>
    <li>
      <a href="../articles/Changing_Populations.html">Changing population</a>
    </li>
    <li>
      <a href="../articles/Checkpoint.html">Saving and restoring simulation state</a>
    </li>
    <li>
      <a href="../articles/Contributing.html">Contributing</a>
    </li>
    <li>
      <a href="../articles/Performance.html">Performance</a>
    </li>
    <li>
      <a href="../articles/Tutorial.html">Tutorial</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/individual/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Saving and restoring simulation state</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/individual/blob/HEAD/vignettes/Checkpoint.Rmd" class="external-link"><code>vignettes/Checkpoint.Rmd</code></a></small>
      <div class="hidden name"><code>Checkpoint.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="intro">Introduction<a class="anchor" aria-label="anchor" href="#intro"></a>
</h2>
<p>When modeling the impact of an intervention on a disease, it is
common to have a first simulation phase where the intervention is
disabled to achieve steady-state, followed by a second phase during
which the intervention is applied. Often, we want to run the second
phase many times over, varying the intervention parameters. Simulating
the first phase every time is unnecessary and wasteful, since it isn’t
affected by the intervention parameters.</p>
<p>Individual allows the user to run a simulation for a number of time
steps, save the state of the simulation and resume it multiple times,
with different parameters each time. This way, the initial phase before
the intervention only needs to be simulated once.</p>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>The typical way to use this feature is to define a simulation
function which creates all the relevant simulation data and then calls
<code>simulation_loop</code>. The function we define takes in an
optional <code>state</code> parameter that is passed through to
<code>simulation_loop</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_simulation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">timesteps</span>, <span class="va">state</span><span class="op">=</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">health</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CategoricalVariable.html">CategoricalVariable</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">process</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bernoulli_process.html">bernoulli_process</a></span><span class="op">(</span><span class="va">health</span>, <span class="st">"S"</span>, <span class="st">"I"</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/simulation_loop.html">simulation_loop</a></span><span class="op">(</span></span>
<span>    variables<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">health</span><span class="op">)</span>,</span>
<span>    processes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">process</span><span class="op">)</span>,</span>
<span>    timesteps<span class="op">=</span><span class="va">timesteps</span>,</span>
<span>    state<span class="op">=</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The simulation can be run a first time, for a given number of steps.
It returns a <em>state object</em>, which captures the internal state of
all variables and events, the state of the random number generator and
the number of time steps that were simulated.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>timesteps <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p>Finally, the simulation is resumed with a larger number of time
steps, passing in the state object as an argument. The
<code>timesteps</code> argument refers to the total number of time
steps, including both the original simulation run and the new one. In
this case, <code>run_simulation</code> will only simulate 50 extra
steps. Before running the actual simulation,
<code>simulation_loop</code> will reload the simulation state from its
argument, overwriting any values we had set when initializing the
variables.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">run_simulation</span><span class="op">(</span>timesteps <span class="op">=</span> <span class="fl">100</span>, state<span class="op">=</span><span class="va">state</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example">Practical example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>To demonstrate the checkpoint and restore functionality of individual
in a practical setting, we will use a SIRS model with a vaccination
intervention. Our aim is to compare the impact of the vaccination
campaign, given different vaccine efficacy scenarios.</p>
<p>Individuals in the simulation move from being susceptible (S) to
infectious (I) to recovered (R) and back to susceptible, after their
natural immunity wanes off. Out of the entire population <code>N</code>,
only <code>I0</code> individuals are initially infectios, and the rest
are susceptible. Orthogonally, an individual can either be vaccinated
(Y) or not (N). The vaccination and the immunity it confers never wanes
off. All individuals are initially unvaccinated.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_variables</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N</span>, <span class="va">I0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">health_states_t0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"S"</span>,<span class="va">N</span><span class="op">)</span></span>
<span>  <span class="va">health_states_t0</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">N</span>,size <span class="op">=</span> <span class="va">I0</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"I"</span></span>
<span>  <span class="va">health</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CategoricalVariable.html">CategoricalVariable</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>categories <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>,<span class="st">"I"</span>,<span class="st">"R"</span><span class="op">)</span>, initial_values <span class="op">=</span> <span class="va">health_states_t0</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">vaccinated</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CategoricalVariable.html">CategoricalVariable</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>categories <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Y"</span>, <span class="st">"N"</span><span class="op">)</span>, initial_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"N"</span>, <span class="va">N</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>health<span class="op">=</span><span class="va">health</span>, vaccinated<span class="op">=</span><span class="va">vaccinated</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>A vaccinated individual has a reduced probability of becoming
infectious, as determined by the vaccine’s efficacy. The function below
creates the process to model infection. It samples from the susceptible
compartments, applying the different rates depending on the whether an
individual’s vaccinated status.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_infection_process</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">health</span>, <span class="va">vaccinated</span>, <span class="va">N</span>, <span class="va">beta</span>, <span class="va">vaccine_efficacy</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">I</span> <span class="op">&lt;-</span> <span class="va">health</span><span class="op">$</span><span class="fu">get_size_of</span><span class="op">(</span><span class="st">"I"</span><span class="op">)</span></span>
<span>    <span class="va">foi</span> <span class="op">&lt;-</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span></span>
<span></span>
<span>    <span class="va">vaccinated_S</span> <span class="op">&lt;-</span> <span class="va">health</span><span class="op">$</span><span class="fu">get_index_of</span><span class="op">(</span><span class="st">"S"</span><span class="op">)</span><span class="op">$</span><span class="fu">and</span><span class="op">(</span><span class="va">vaccinated</span><span class="op">$</span><span class="fu">get_index_of</span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">non_vaccinated_S</span> <span class="op">&lt;-</span> <span class="va">health</span><span class="op">$</span><span class="fu">get_index_of</span><span class="op">(</span><span class="st">"S"</span><span class="op">)</span><span class="op">$</span><span class="fu">and</span><span class="op">(</span><span class="va">vaccinated</span><span class="op">$</span><span class="fu">get_index_of</span><span class="op">(</span><span class="st">"N"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">vaccinated_S</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>rate <span class="op">=</span> <span class="va">foi</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">vaccine_efficacy</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">non_vaccinated_S</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>rate <span class="op">=</span> <span class="va">foi</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">health</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>value <span class="op">=</span> <span class="st">"I"</span>, index <span class="op">=</span> <span class="va">vaccinated_S</span><span class="op">)</span></span>
<span>    <span class="va">health</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>value <span class="op">=</span> <span class="st">"I"</span>, index <span class="op">=</span> <span class="va">non_vaccinated_S</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For a while at the start of the simulation no vaccination takes
place. Only after a number of time steps, determined by the
<code>vaccination_start</code> parameter, does the intervention begin.
Periodically, an event will fire and every individual has a fixed
probability of becoming vaccinated. If <code>vaccination_start</code> is
<code>NULL</code>, the intervention never begins.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_vaccination_event</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vaccinated</span>, <span class="va">vaccination_start</span>, <span class="va">vaccination_interval</span>, <span class="va">vaccination_rate</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">e</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Event.html">Event</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">e</span><span class="op">$</span><span class="fu">add_listener</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vaccinated</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>value <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>      <span class="va">vaccinated</span><span class="op">$</span><span class="fu">get_index_of</span><span class="op">(</span><span class="st">"N"</span><span class="op">)</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span><span class="va">vaccination_rate</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">e</span><span class="op">$</span><span class="fu">schedule</span><span class="op">(</span><span class="va">vaccination_interval</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">vaccination_start</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">e</span><span class="op">$</span><span class="fu">schedule</span><span class="op">(</span><span class="va">vaccination_start</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">e</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We will define our simulation as a function, taking the simulation
parameters as arguments. Any additional arguments to the function, as
denoted by <code>...</code>, will be passed on to
<code>simulation_loop</code>. This will allow us to pass the
<code>state</code> argument in. The function returns the simulation data
as well as the new saved state.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_simulation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">steps</span>,</span>
<span>    <span class="va">N</span> <span class="op">=</span> <span class="fl">1e3</span>,</span>
<span>    <span class="va">I0</span> <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    <span class="va">beta</span> <span class="op">=</span> <span class="fl">0.1</span>, <span class="co"># S -&gt; I</span></span>
<span>    <span class="va">gamma</span> <span class="op">=</span> <span class="fl">0.05</span>, <span class="co"># I -&gt; R</span></span>
<span>    <span class="va">xi</span> <span class="op">=</span> <span class="fl">0.03</span>, <span class="co"># R -&gt; S</span></span>
<span>    <span class="va">vaccination_start</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    <span class="va">vaccination_interval</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    <span class="va">vaccination_rate</span> <span class="op">=</span> <span class="fl">0.05</span>, <span class="co"># N -&gt; Y</span></span>
<span>    <span class="va">vaccine_efficacy</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu">make_variables</span><span class="op">(</span><span class="va">N</span>, <span class="va">I0</span><span class="op">)</span></span>
<span>  <span class="va">infection_process</span> <span class="op">&lt;-</span> <span class="fu">make_infection_process</span><span class="op">(</span></span>
<span>    <span class="va">variables</span><span class="op">$</span><span class="va">health</span>,</span>
<span>    <span class="va">variables</span><span class="op">$</span><span class="va">vaccinated</span>,</span>
<span>    <span class="va">N</span>, <span class="va">beta</span>, <span class="va">vaccine_efficacy</span><span class="op">)</span></span>
<span>  <span class="va">recovery_process</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bernoulli_process.html">bernoulli_process</a></span><span class="op">(</span><span class="va">variables</span><span class="op">$</span><span class="va">health</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="va">gamma</span><span class="op">)</span></span>
<span>  <span class="va">return_process</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bernoulli_process.html">bernoulli_process</a></span><span class="op">(</span><span class="va">variables</span><span class="op">$</span><span class="va">health</span>, <span class="st">"R"</span>, <span class="st">"S"</span>, <span class="va">xi</span><span class="op">)</span></span>
<span>  <span class="va">vaccination_event</span> <span class="op">&lt;-</span> <span class="fu">make_vaccination_event</span><span class="op">(</span></span>
<span>    <span class="va">variables</span><span class="op">$</span><span class="va">vaccinated</span>, <span class="va">vaccination_start</span>, <span class="va">vaccination_interval</span>, <span class="va">vaccination_rate</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">renderer</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Render.html">Render</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>timesteps <span class="op">=</span> <span class="va">steps</span><span class="op">)</span></span>
<span>  <span class="va">health_render_process</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/categorical_count_renderer_process.html">categorical_count_renderer_process</a></span><span class="op">(</span></span>
<span>    renderer <span class="op">=</span> <span class="va">renderer</span>,</span>
<span>    variable <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">health</span>,</span>
<span>    categories <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">health</span><span class="op">$</span><span class="fu">get_categories</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">processes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="va">infection_process</span>,</span>
<span>    <span class="va">recovery_process</span>,</span>
<span>    <span class="va">return_process</span>,</span>
<span>    <span class="va">health_render_process</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">final_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulation_loop.html">simulation_loop</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="va">variables</span>,</span>
<span>    events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">vaccination_event</span><span class="op">)</span>,</span>
<span>    processes <span class="op">=</span> <span class="va">processes</span>,</span>
<span>    timesteps <span class="op">=</span> <span class="va">steps</span>,</span>
<span>    <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>result<span class="op">=</span><span class="va">renderer</span><span class="op">$</span><span class="fu">to_dataframe</span><span class="op">(</span><span class="op">)</span>, state<span class="op">=</span><span class="va">final_state</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We will start by running and plotting our baseline simulation, with
the intervention disabled.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps<span class="op">=</span><span class="fl">1500</span><span class="op">)</span><span class="op">$</span><span class="va">result</span></span>
<span><span class="va">colours</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"royalblue3"</span>,<span class="st">"firebrick3"</span>,<span class="st">"darkorchid3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  x<span class="op">=</span><span class="va">data</span><span class="op">[</span><span class="st">"timestep"</span><span class="op">]</span>,</span>
<span>  y<span class="op">=</span><span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S_count"</span>,<span class="st">"I_count"</span>, <span class="st">"R_count"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  xlab<span class="op">=</span><span class="st">"Time"</span>, ylab<span class="op">=</span><span class="st">"Count"</span>,</span>
<span>  type<span class="op">=</span><span class="st">"l"</span>, lwd<span class="op">=</span><span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">colours</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span></span>
<span>   x <span class="op">=</span> <span class="st">"topright"</span>,</span>
<span>   pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">16</span>,<span class="fl">3</span><span class="op">)</span>,</span>
<span>   col <span class="op">=</span> <span class="va">colours</span>,</span>
<span>   legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>   bg<span class="op">=</span><span class="st">'white'</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="Checkpoint_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>We see that the simulation takes some time to settle from its initial
parameters to its steady-state conditions. We will now enable the
vaccine intervention, but only starting at a point after the simulation
has settled, for example at <code>t=500</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps<span class="op">=</span><span class="fl">1500</span>, vaccination_start <span class="op">=</span> <span class="fl">500</span>, vaccine_efficacy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">result</span></span>
<span><span class="va">colours</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"royalblue3"</span>,<span class="st">"firebrick3"</span>,<span class="st">"darkorchid3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  x<span class="op">=</span><span class="va">data</span><span class="op">[</span><span class="st">"timestep"</span><span class="op">]</span>,</span>
<span>  y<span class="op">=</span><span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S_count"</span>,<span class="st">"I_count"</span>, <span class="st">"R_count"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  xlab<span class="op">=</span><span class="st">"Time"</span>, ylab<span class="op">=</span><span class="st">"Count"</span>,</span>
<span>  type<span class="op">=</span><span class="st">"l"</span>, lwd<span class="op">=</span><span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">colours</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span></span>
<span>   x <span class="op">=</span> <span class="st">"topright"</span>,</span>
<span>   pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">16</span>,<span class="fl">3</span><span class="op">)</span>,</span>
<span>   col <span class="op">=</span> <span class="va">colours</span>,</span>
<span>   legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>   bg<span class="op">=</span><span class="st">'white'</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="Checkpoint_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>The simulation above clearly shows the effect of the vaccination
campaign, starting at <code>t=500</code>. However, it made the
optimistic assumption of a 100% vaccine efficacy. We wish to run the
simulation again but with varying levels of efficacy, in order the
compare its impact.</p>
<p>While we could run the code above many times over, each simulation
would repeat the first 499 timesteps, despite the result being identical
each time. Instead we start by running only these timesteps, and saving
the result. We do need to specify the start of the intervention, as it
is necessary to schedule the first vaccination event. However the
details of the intervention (ie. <code>vaccine_efficacy</code>) are
irrelevant and can be omitted.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">initial</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps<span class="op">=</span><span class="fl">499</span>, vaccination_start <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span></code></pre></div>
<p>From this initial result, we can resume the simulation, but using
different values of vaccine efficacy each time. We also include a
control simulation, in which no vaccination takes place. Each of these
simulation will skip the first 499 steps and only run the next 1001 time
steps.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control</span>    <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps<span class="op">=</span><span class="fl">1500</span>, vaccination_start <span class="op">=</span> <span class="fl">500</span>, vaccine_efficacy<span class="op">=</span><span class="fl">0.0</span>, state<span class="op">=</span><span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">vaccine30</span>  <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps<span class="op">=</span><span class="fl">1500</span>, vaccination_start <span class="op">=</span> <span class="fl">500</span>, vaccine_efficacy<span class="op">=</span><span class="fl">0.3</span>, state<span class="op">=</span><span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">vaccine50</span>  <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps<span class="op">=</span><span class="fl">1500</span>, vaccination_start <span class="op">=</span> <span class="fl">500</span>, vaccine_efficacy<span class="op">=</span><span class="fl">0.5</span>, state<span class="op">=</span><span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">vaccine100</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps<span class="op">=</span><span class="fl">1500</span>, vaccination_start <span class="op">=</span> <span class="fl">500</span>, vaccine_efficacy<span class="op">=</span><span class="fl">1.0</span>, state<span class="op">=</span><span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span></code></pre></div>
<p>Finally we aggregate and plot the results from all these simulations.
We also need to include the data from our initial run, which we will
plot the same colour as our control simulation.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colours</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"royalblue3"</span>,<span class="st">"firebrick3"</span>,<span class="st">"darkorchid3"</span>, <span class="st">"seagreen3"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pad initial out to ensure it has the same shape as other series.</span></span>
<span><span class="va">initial</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fl">500</span><span class="op">:</span><span class="fl">1500</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    <span class="va">initial</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">vaccine30</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">vaccine50</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">vaccine100</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">control</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Infected count"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">colours</span>,</span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span></span>
<span>   x <span class="op">=</span> <span class="st">"topright"</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">16</span>,<span class="fl">3</span><span class="op">)</span>,</span>
<span>   col <span class="op">=</span> <span class="va">colours</span>,</span>
<span>   legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"30%"</span>, <span class="st">"50%"</span>, <span class="st">"100%"</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>   bg<span class="op">=</span><span class="st">'white'</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="Checkpoint_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="caveats">Caveats<a class="anchor" aria-label="anchor" href="#caveats"></a>
</h2>
<p>Saving and restoring the simulation state comes with a number of
caveats.</p>
<ul>
<li>All simulation state must be represented as objects managed by
individual. Any state maintained externally will not be saved nor
restored.</li>
<li>The state object’s structure is not stable and is expected to
change. One should not expect to serialize the state to disk and have it
work with future versions of the individual package.</li>
<li>The simulation must be re-created in an identical way. Variables and
events may not be added or removed, variable sizes must remain constant,
the list of categories in a <code>CategoricalVariable</code> cannot be
modified, etc. The order of variables and events passed to the
<code>run_simulation</code> function must remain stable.</li>
<li>If an event is scheduled before the checkpoint, the time at which it
will execute cannot be changed when resuming, even if that time is in
the future. For example in the SIRS model above, we would not be able to
resume the simulation with different values for
<code>vaccination_start</code>; changing that parameter would have no
effect.</li>
</ul>
<p>While parameters of the simulation can be changed between the initial
run and the subsequent runs (as demonstrated with the
<code>vaccine_efficacy</code> parameter above), in general you should
not modify parameters that would have been already had an impact on the
first part of the simulation. Doing so would produce results that can
only be produced through checkpoint and resume, and not as a single
simulation.</p>
<p>For example, in our SIRS model, it may be tempting to model a
time-varying parameter by running half of the simulation with one value
and then resuming it with a different value. While this would probably
work, it would be brittle and hard to compose. As more time-varying
parameters are introduced to the model, the simulation would need to be
saved and restored each time a value changes.</p>
<div class="section level3">
<h3 id="rng">Restoring random number generator state<a class="anchor" aria-label="anchor" href="#rng"></a>
</h3>
<p>By default resuming a simulation does not restore R’s random number
generator’s state. Every resumed run from the same saved state will be
independent and, if the model is stochastic, will produce different
results.</p>
<p>We can demonstrate that by running the baseline of our SIRS model
multiple times and plotting the results. All three runs start off from
the same state, inherited from our original model run, but quickly
diverge based on the outcome of random draws.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">initial</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps<span class="op">=</span><span class="fl">499</span><span class="op">)</span></span>
<span><span class="va">run1</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span>, state <span class="op">=</span> <span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">run2</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span>, state <span class="op">=</span> <span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">run3</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span>, state <span class="op">=</span> <span class="va">initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span></span>
<span><span class="va">initial</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fl">500</span><span class="op">:</span><span class="fl">1500</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    <span class="va">initial</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">run1</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">run2</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span>,</span>
<span>    <span class="va">run3</span><span class="op">$</span><span class="va">result</span><span class="op">[</span>,<span class="st">"I_count"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Infected count"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="va">colours</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="Checkpoint_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>Sometimes this behaviour may not be desirable, and we would instead
like to restore the state of the random number generator exactly where
it was when we stopped the first part of the run. One example of this is
when checking that our model behaves the same whether or not it was
saved and resumed.</p>
<p>The code below show an attempt at running the model twice, once as a
continous run and once in a piecewise manner. We would hope that seeding
the random generator at the start of the simulation would be enough to
get identical results out of it. Unfortunately we don’t, because the
random number generator state’s at the intermediate point isn’t being
preserved.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">uninterrupted_run</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span><span class="op">)</span><span class="op">$</span><span class="va">result</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">piecewise_run_initial</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">499</span><span class="op">)</span></span>
<span><span class="va">piecewise_run_final</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span>, state <span class="op">=</span> <span class="va">piecewise_run_initial</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="va">piecewise_run</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">piecewise_run_initial</span><span class="op">$</span><span class="va">result</span>, <span class="va">piecewise_run_final</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fl">500</span><span class="op">:</span><span class="fl">1500</span>,<span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">uninterrupted_run</span>, <span class="va">piecewise_run</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Component \"S_count\": Mean relative difference: 0.1454073"</span></span>
<span><span class="co">#&gt; [2] "Component \"I_count\": Mean relative difference: 0.6820171"</span></span>
<span><span class="co">#&gt; [3] "Component \"R_count\": Mean relative difference: 0.625746"</span></span></code></pre></div>
<p>We can try the same again, but this time set
<code>restore_random_state = TRUE</code> to enable restoring the
simulation state. This time we’ve successfully managed to reproduce the
data from our uninterrupted run.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">piecewise_run_initial</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">499</span><span class="op">)</span></span>
<span><span class="va">piecewise_run_final</span> <span class="op">&lt;-</span> <span class="fu">run_simulation</span><span class="op">(</span>steps <span class="op">=</span> <span class="fl">1500</span>, state <span class="op">=</span> <span class="va">piecewise_run_initial</span><span class="op">$</span><span class="va">state</span>, restore_random_state <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">piecewise_run</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">piecewise_run_initial</span><span class="op">$</span><span class="va">result</span>, <span class="va">piecewise_run_final</span><span class="op">$</span><span class="va">result</span><span class="op">[</span><span class="fl">500</span><span class="op">:</span><span class="fl">1500</span>,<span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">uninterrupted_run</span>, <span class="va">piecewise_run</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Component \"S_count\": Mean relative difference: 0.05500226"</span></span>
<span><span class="co">#&gt; [2] "Component \"I_count\": Mean relative difference: 0.2852969" </span></span>
<span><span class="co">#&gt; [3] "Component \"R_count\": Mean relative difference: 0.274895"</span></span></code></pre></div>
<p>Using <code>restore_random_state = TRUE</code> resets the global
random number generator’s state, which could have surprising and
undesirable side effects. It is generally useful in tests, but should be
used carefully elsewhere.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">.GlobalEnv</span><span class="op">$</span><span class="va">.Random.seed</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1]       10403         624  -983674937   643431772  1162448557  -959247990</span></span>
<span><span class="co">#&gt;   [7]  -133913213  2107846888   370274761 -2022780170  -412390145   848182068</span></span>
<span><span class="co">#&gt;  [13]  -266662747 -1309507294  1356997179  1661823040  1749531457  -516669426</span></span>
<span><span class="co">#&gt;  [19]  1042678071 -1279933428  -410084963  1151007674  -895613453  1288379032</span></span>
<span><span class="co">#&gt;  [25]  -376044615 -1358274522   307686511   101447652  1796216213 -1567696558</span></span>
<span><span class="co">#&gt;  [31]  1186934955 -1925339152  -472470735    80319294 -1524429145   326645436</span></span>
<span><span class="co">#&gt;  [37]  -389586803  -400786966  -890731933  -852332472  1365217705 -1785317034</span></span>
<span><span class="co">#&gt;  [43] -1551153185  1359863956  2098748037 -1013039742  -329721061 -1587358816</span></span>
<span><span class="co">#&gt;  [49]   344102689 -1520389522   166492183  1821136236  1646453629  1056605210</span></span>
<span><span class="co">#&gt;  [55] -1419044141  -806080008   520985497   711286406  2004844367 -1445006012</span></span>
<span><span class="co">#&gt;  [61]  1329781621 -1188844110 -1089068661  1173875536 -1983217903   514629022</span></span>
<span><span class="co">#&gt;  [67]  -237421177  -258138084  -930078099   261626442  1349308227 -1125425240</span></span>
<span><span class="co">#&gt;  [73] -1677778551    25874358   409637567 -1987430924  1583257701  -136173086</span></span>
<span><span class="co">#&gt;  [79]   639501307   272101120 -1024630015 -1994369842  -939499785 -1944742196</span></span>
<span><span class="co">#&gt;  [85]  -591520419 -1994900358  1072996275  1119025496  2035491705 -2082894618</span></span>
<span><span class="co">#&gt;  [91]   776176175   -69557596  1794806101  -178474478  -497581461   874372784</span></span>
<span><span class="co">#&gt;  [97]   518669041  -370223106  1295572071 -1776240260 -1692674995  1935534762</span></span>
<span><span class="co">#&gt; [103]   298421283   111542024 -1075273367   518297110  -289321569  1331379028</span></span>
<span><span class="co">#&gt; [109]  1768277573  1473660482  2120850651   879016544  -864018719  1661675310</span></span>
<span><span class="co">#&gt; [115]   135902679 -2136373204   735594301  1594631386  -546138989  1423929528</span></span>
<span><span class="co">#&gt; [121] -1067541671  1962863430 -1923418865  -984154108  1907308341   642901618</span></span>
<span><span class="co">#&gt; [127] -1095019701 -1836613104 -1171392815  1663582814 -1258689721 -2007301412</span></span>
<span><span class="co">#&gt; [133]  -756910547  -712643830 -1271482109  -801485208    51646793 -1925477258</span></span>
<span><span class="co">#&gt; [139] -1421379457  1104736436 -1348082651  -124611934   292791739  2126591424</span></span>
<span><span class="co">#&gt; [145] -2043491647  -709285490 -1242530633  1688217996  -538353379 -1997652678</span></span>
<span><span class="co">#&gt; [151]   -48432781   575772696   942146361    57506214  -948054033   -72610460</span></span>
<span><span class="co">#&gt; [157]  1389939989   656100050   -25586645 -2012424848  1854773937  1391516862</span></span>
<span><span class="co">#&gt; [163] -2100008409  -140248004 -1638135795 -2077746326  -118729245 -1417654840</span></span>
<span><span class="co">#&gt; [169]   662270249   942125782 -1363864737   744183316  2123821573   -80802046</span></span>
<span><span class="co">#&gt; [175] -1753997669  1277518112  1090348705  1338137582   423408535   -28214548</span></span>
<span><span class="co">#&gt; [181]  1164536573  1524008346   673959507   853634936 -1599644903 -2135083002</span></span>
<span><span class="co">#&gt; [187]  -345756977 -1070478652   971985653  -556736718  -406174453   663083216</span></span>
<span><span class="co">#&gt; [193]  1258368657  1306568478  1820350727 -1068259940  -402617875  1499233226</span></span>
<span><span class="co">#&gt; [199] -1121819965 -1773142744  1796260105  1463879990   901914175   104491892</span></span>
<span><span class="co">#&gt; [205]  1605431269 -1933329566  1688405883  -446088064  1238889089   197049934</span></span>
<span><span class="co">#&gt; [211]  -709469577 -1072333748  1691378909 -1260585478   198644531  2053568216</span></span>
<span><span class="co">#&gt; [217]   903127801 -1970919834  -473567825  1614821412 -1905604395  1082827666</span></span>
<span><span class="co">#&gt; [223]  1558537707  1875545136  1518383729 -1265655426 -2085242905  1791098620</span></span>
<span><span class="co">#&gt; [229]  1447558093 -1153758166   -99557469   -92185464 -2016280343  1847562134</span></span>
<span><span class="co">#&gt; [235]  1495701791  -221368108   409722309  -429353022  1765302363  2137311200</span></span>
<span><span class="co">#&gt; [241]  -373658015   273043630  -350916265  -935055956    43404989    52012634</span></span>
<span><span class="co">#&gt; [247]  1867958291  1488596536 -1347953959   174081222  2002460815  1429165444</span></span>
<span><span class="co">#&gt; [253]  -205312331  1264621554  -603785525  1270017936 -1543231919 -1282028578</span></span>
<span><span class="co">#&gt; [259]   908887751   726075484  1269456301 -1680094070  -990917501 -1377014808</span></span>
<span><span class="co">#&gt; [265] -1279971127  1281050102   228230143  1097770548 -1438663771  1295361058</span></span>
<span><span class="co">#&gt; [271]   829172027   988808000  1704778305   804328206 -1257113545  -516583668</span></span>
<span><span class="co">#&gt; [277] -1624037219  1034190522   904064243 -1716316776  1108935353   904106790</span></span>
<span><span class="co">#&gt; [283]  1222361967  1146561252  1232110741   174767186  2136668075 -1843985680</span></span>
<span><span class="co">#&gt; [289]   713263665  1133192766  1302119847  -499465796  -425742451  2035727594</span></span>
<span><span class="co">#&gt; [295]  1324820835  -227988664 -1598926679   227290198   601218783  1836305300</span></span>
<span><span class="co">#&gt; [301]  1386514821   306372738  -445226469   618852000   -25741791   156697966</span></span>
<span><span class="co">#&gt; [307]  -345772265 -2126405524  1998516861  -392853734  1588822483  1965665528</span></span>
<span><span class="co">#&gt; [313] -1658840423 -1901588090  -687876529   -15753148 -1427453323 -1799286606</span></span>
<span><span class="co">#&gt; [319]   -47880053    97437264  -319365615   688369822  -272731001   469052188</span></span>
<span><span class="co">#&gt; [325]    27259245  1573117258  -446761405  1976539816  2093047945   424297142</span></span>
<span><span class="co">#&gt; [331]  1217440191   506831092 -1961736347 -1834464030  1234111227   907381248</span></span>
<span><span class="co">#&gt; [337]  -247365119   118499278 -1581033993  -893361716 -2100188067   335855482</span></span>
<span><span class="co">#&gt; [343]    83920563 -1896483752  -323673479  -498745370  2088720687 -2102342236</span></span>
<span><span class="co">#&gt; [349]  1873412181   226202898 -1483060885  1437743536  -430562831  -190616834</span></span>
<span><span class="co">#&gt; [355] -1639345305   281953404   857940813  -549769814  -245419229  1375189512</span></span>
<span><span class="co">#&gt; [361]  -237346711   590186774    75687071   655107668   151057733   930998594</span></span>
<span><span class="co">#&gt; [367] -1108466725  1398789472  1995685345  1605663278  1206398167 -1945513172</span></span>
<span><span class="co">#&gt; [373]  1992513085  1544169434  1610742675  -152048712  -657450407  1247059526</span></span>
<span><span class="co">#&gt; [379]  1880247311  -124605692   723920437 -1548596878  1827773003   479812880</span></span>
<span><span class="co">#&gt; [385]   228152785    49698142   922100295 -1524757028  -845069011   534031882</span></span>
<span><span class="co">#&gt; [391]  -131080189   213485928   636833865   718143350 -1134260353 -2024842316</span></span>
<span><span class="co">#&gt; [397] -1108831451  1977333154  1053535419  1301926080  -997856831   366738574</span></span>
<span><span class="co">#&gt; [403] -1450544201  1064694924 -1016336355  -390217670 -1024466829   686789400</span></span>
<span><span class="co">#&gt; [409] -2056715719   745319590  -999248145 -1240647580 -1395180523 -1837290030</span></span>
<span><span class="co">#&gt; [415]  -681354453  -514051984  1438153137  2090364862  -209968857  1765574460</span></span>
<span><span class="co">#&gt; [421]  -544057587  -844603798 -1693909789 -1746073400 -1156960215  2076419542</span></span>
<span><span class="co">#&gt; [427] -1326601633  1784103188  -683597563  -824593918  1683989915  -509903840</span></span>
<span><span class="co">#&gt; [433]   183502241  -132206866  -295556457   190629356 -1790739971  1849133210</span></span>
<span><span class="co">#&gt; [439] -1660799661   214755960 -1837639143   975563526  1750237647  1014527428</span></span>
<span><span class="co">#&gt; [445]     3490293   552878642   220695563   382907344 -1381266031  1445050910</span></span>
<span><span class="co">#&gt; [451]  1771278343 -1719553892   862869741   583941834 -1759344189  1365915688</span></span>
<span><span class="co">#&gt; [457]  -820969463 -1381598154   -19516097   662427252 -1098735899  -812655006</span></span>
<span><span class="co">#&gt; [463]  1658982011 -1203972224  1999245697 -1592487602 -1708699273 -1038727348</span></span>
<span><span class="co">#&gt; [469]  -725486627   747602170  2037447219  -161484328   469017081  1897421158</span></span>
<span><span class="co">#&gt; [475]   644859055   959210276  1824012245 -1573943662  -797561621   466937648</span></span>
<span><span class="co">#&gt; [481]     6984049  1344943230 -1963692313   507873788  1336756941  -446804182</span></span>
<span><span class="co">#&gt; [487]  -978024797    50927496   -66994199 -1542552938 -1630130145  1108679636</span></span>
<span><span class="co">#&gt; [493]   421858501   286669506   176875355  1716904672   841747809  2002101166</span></span>
<span><span class="co">#&gt; [499] -1936594857  -503678804   643784125  -270685862    -9162989 -1518294728</span></span>
<span><span class="co">#&gt; [505] -1177069095   450623430 -1518307441 -2055143292  1977097653  1967586034</span></span>
<span><span class="co">#&gt; [511]  2139569611   993708688   887981393  -146153762 -1521041977 -1948249252</span></span>
<span><span class="co">#&gt; [517]  1992764589  1735430026   469169027  -492722456  1473540041 -1902921482</span></span>
<span><span class="co">#&gt; [523]  1705351935  1769673012  -929011035   948225826  -946720709  1824431680</span></span>
<span><span class="co">#&gt; [529]  1626208577 -1384520178    22671159 -1788782068  -359417955   272236986</span></span>
<span><span class="co">#&gt; [535]  -230435853  1174868120 -2145910343  -855063002  1748802159   651054564</span></span>
<span><span class="co">#&gt; [541]  -619908203    89300818   345161387 -1411621392   774662449 -1541883586</span></span>
<span><span class="co">#&gt; [547]  1651670183   581520572 -1489764723 -2028142614 -1423847325 -1844713912</span></span>
<span><span class="co">#&gt; [553]  1954615209  -389144746    66876895  2030417556  -361973627  -151813246</span></span>
<span><span class="co">#&gt; [559] -1573918437   944703904   610784545  1108957294 -1875417577 -1297945748</span></span>
<span><span class="co">#&gt; [565]  1037500797  1908181530   823650515  1875585016   -22111847  1765196934</span></span>
<span><span class="co">#&gt; [571]  -849597105  1315720004 -1748059787  -915770446   634433419 -1869504176</span></span>
<span><span class="co">#&gt; [577]  -887145199  2066662302  -939545721  -822528484 -1687437203 -1367629750</span></span>
<span><span class="co">#&gt; [583] -1603461821   522180008  1610588041  2052437430   110280895  2014120948</span></span>
<span><span class="co">#&gt; [589]  -670960027   159018978  1050415611   568272128 -1718509311    -3409202</span></span>
<span><span class="co">#&gt; [595]   753028343 -1139331892  -123651235 -2072165766 -1222087245   648343384</span></span>
<span><span class="co">#&gt; [601]  1100161401   486404838   261566511  1504901284  -476745899  1151760402</span></span>
<span><span class="co">#&gt; [607]  -445050773  -130902864  -423755535  1831075326   934693479   690474876</span></span>
<span><span class="co">#&gt; [613]  -907644339  -744197974  1158732323    62223624 -1538777239  1455586326</span></span>
<span><span class="co">#&gt; [619]  -702514273 -1712778924   651699269   959548482  -586241317  1850142816</span></span>
<span><span class="co">#&gt; [625]  -647799583  2099891502</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.2875775 0.7883051 0.4089769 0.8830174 0.9404673</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Giovanni Charles, Sean L. Wu, Peter Winskill, Paul Liétar.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
